import json
import random
from pathlib import Path
from playwright.sync_api import sync_playwright
from datetime import datetime, timedelta
import os

# ÁîüÊàêÁöÑÂïÜÂìÅÊï∞Èáè
NUM_PRODUCTS = 6  # 6‰∏™ÈúÄË¶ÅÊõøÊç¢ÁöÑÂïÜÂìÅÂõæÁâá‰ΩçÁΩÆ

# HTMLÈ°µÈù¢Ê®°ÊùøÔºàÂÆåÂÖ®Â§çÂà∂Ëá™amazon.htmlÔºâ
HTML_TEMPLATE = '''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon.com: Small space solutions: living</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}

        body {{
            font-family: "Amazon Ember", Arial, sans-serif;
            background-color: #fff;
            color: #0F1111;
        }}

        /* Header Styles */
        .header {{
            background-color: #232F3E;
            padding: 8px 0;
            position: relative;
        }}

        .header-content {{
            max-width: 1500px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 15px;
        }}

        .logo {{
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-right: 20px;
            text-decoration: none;
        }}

        .deliver-to {{
            color: #ccc;
            font-size: 12px;
            margin-right: 20px;
        }}

        .deliver-to .location {{
            color: white;
            font-weight: bold;
        }}

        .search-container {{
            flex: 1;
            display: flex;
            max-width: 600px;
            margin: 0 20px;
        }}

        .search-dropdown {{
            background-color: #f3f3f3;
            border: none;
            padding: 10px;
            border-radius: 4px 0 0 4px;
            font-size: 12px;
        }}

        .search-input {{
            flex: 1;
            padding: 10px;
            border: none;
            font-size: 16px;
        }}

        .search-button {{
            background-color: #febd69;
            border: none;
            padding: 10px 15px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }}

        .header-right {{
            display: flex;
            align-items: center;
            gap: 20px;
        }}

        .header-link {{
            color: white;
            text-decoration: none;
            font-size: 14px;
        }}

        .cart {{
            position: relative;
        }}

        .cart-count {{
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ff9900;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }}

        /* Navigation Bar */
        .nav-bar {{
            background-color: #37475A;
            padding: 8px 0;
        }}

        .nav-content {{
            max-width: 1500px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 15px;
        }}

        .nav-link {{
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 2px;
        }}

        .nav-link:hover {{
            background-color: rgba(255,255,255,0.1);
        }}

        /* Main Content */
        .main-container {{
            max-width: 1500px;
            margin: 0 auto;
            display: flex;
            padding: 20px 15px;
            gap: 20px;
        }}

        /* Sidebar */
        .sidebar {{
            width: 240px;
            flex-shrink: 0;
        }}

        .filter-section {{
            margin-bottom: 20px;
        }}

        .filter-title {{
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #0F1111;
        }}

        .filter-item {{
            margin-bottom: 8px;
            font-size: 13px;
        }}

        .filter-item a {{
            color: #007185;
            text-decoration: none;
        }}

        .filter-item a:hover {{
            text-decoration: underline;
        }}

        .checkbox-item {{
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }}

        .checkbox-item input {{
            margin-right: 8px;
        }}

        .stars {{
            color: #ffa500;
            margin-right: 5px;
        }}

        /* Main Content Area */
        .content {{
            flex: 1;
        }}

        .results-header {{
            margin-bottom: 20px;
            font-size: 16px;
        }}

        .results-count {{
            color: #565959;
        }}

        .search-term {{
            color: #C7511F;
        }}

        /* Product Grid */
        .product-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }}

        .product-card {{
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: white;
            position: relative;
        }}

        .best-seller {{
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #ff9900;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
            font-weight: bold;
        }}

        .product-image {{
            width: 100%;
            height: 200px;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 4px;
        }}

        .product-title {{
            font-size: 16px;
            font-weight: normal;
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }}

        .product-title a {{
            color: #0F1111;
            text-decoration: none;
        }}

        .product-title a:hover {{
            color: #C7511F;
        }}

        .product-rating {{
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }}

        .rating-stars {{
            color: #ffa500;
            margin-right: 5px;
        }}

        .rating-count {{
            color: #007185;
            font-size: 13px;
        }}

        .purchase-info {{
            font-size: 13px;
            color: #565959;
            margin-bottom: 8px;
        }}

        .product-price {{
            font-size: 18px;
            font-weight: bold;
            color: #B12704;
        }}

        .price-small {{
            font-size: 13px;
            color: #565959;
        }}

        .limited-deal {{
            background-color: #CC0C39;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
            margin-top: 8px;
            display: inline-block;
        }}

        .product-options {{
            font-size: 13px;
            color: #565959;
            margin-top: 8px;
        }}

        /* Responsive Design */
        @media (max-width: 1024px) {{
            .main-container {{
                flex-direction: column;
            }}
            
            .sidebar {{
                width: 100%;
            }}
            
            .product-grid {{
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }}
        }}

        @media (max-width: 768px) {{
            .header-content {{
                flex-wrap: wrap;
            }}
            
            .search-container {{
                order: 3;
                width: 100%;
                margin: 10px 0 0 0;
            }}
            
            .product-grid {{
                grid-template-columns: 1fr;
            }}
        }}
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">amazon</a>
            
            <div class="deliver-to">
                <div>Deliver to</div>
                <div class="location">üá∫üá∏ Japan</div>
            </div>
            
            <div class="search-container">
                <select class="search-dropdown">
                    <option>All</option>
                </select>
                <input type="text" class="search-input" placeholder="Search Amazon">
                <button class="search-button">üîç</button>
            </div>
            
            <div class="header-right">
                <div class="header-link">üá∫üá∏ EN</div>
                <div class="header-link">
                    <div>Hello, sign in</div>
                    <div><strong>Account & Lists</strong></div>
                </div>
                <div class="header-link">
                    <div>Returns</div>
                    <div><strong>& Orders</strong></div>
                </div>
                <div class="cart">
                    <div class="header-link"><strong>üõí Cart</strong></div>
                    <div class="cart-count">0</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-content">
            <a href="#" class="nav-link">‚ò∞ All</a>
            <a href="#" class="nav-link">Today's Deals</a>
            <a href="#" class="nav-link">Registry</a>
            <a href="#" class="nav-link">Prime Video</a>
            <a href="#" class="nav-link">Gift Cards</a>
            <a href="#" class="nav-link">Customer Service</a>
            <a href="#" class="nav-link">Sell</a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="filter-section">
                <h3 class="filter-title">Department</h3>
                <div class="filter-item">
                    <a href="#">< Home & Kitchen</a>
                </div>
                <div class="filter-item" style="margin-left: 20px;">
                    <strong>Small space solutions: living</strong>
                </div>
                <div class="filter-item" style="margin-left: 40px;">
                    <a href="#">Bedding</a>
                </div>
                <div class="filter-item" style="margin-left: 40px;">
                    <a href="#">Furniture</a>
                </div>
                <div class="filter-item" style="margin-left: 40px;">
                    <a href="#">Home D√©cor Products</a>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">Brands</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="amazon-basics">
                    <label for="amazon-basics">Amazon Basics</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="signature-design">
                    <label for="signature-design">Signature Design by Ashley</label>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">Customer Reviews</h3>
                <div class="filter-item">
                    <a href="#">
                        <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span> & Up
                    </a>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">Condition</h3>
                <div class="filter-item">
                    <a href="#">New</a>
                </div>
                <div class="filter-item">
                    <a href="#">Used</a>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">Price</h3>
                <div class="filter-item">
                    <a href="#">Under $25</a>
                </div>
                <div class="filter-item">
                    <a href="#">$25 to $50</a>
                </div>
                <div class="filter-item">
                    <a href="#">$100 to $200</a>
                </div>
                <div class="filter-item">
                    <a href="#">$200 & Above</a>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="filter-title">Deals & Discounts</h3>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <div class="results-header">
                <span class="results-count">1-12 of 78 results for</span>
                <span class="search-term">Small space solutions: living</span>
            </div>

            <div class="product-grid">
                <!-- Product 1 -->
                <div class="product-card">
                    <div class="best-seller">Best Seller</div>
                    <img src="{product1_image}" alt="Product image" class="product-image"{product1_id}>
                    <h3 class="product-title">
                        <a href="#">{product1_title}</a>
                    </h3>
                    <div class="product-rating">
                        <span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                        <span class="rating-count">2,866</span>
                    </div>
                    <div class="purchase-info">10K+ bought in past month</div>
                </div>

                <!-- Product 2 -->
                <div class="product-card">
                    <div class="best-seller">Best Seller</div>
                    <img src="{product2_image}" alt="Product image" class="product-image"{product2_id}>
                    <h3 class="product-title">
                        <a href="#">{product2_title}</a>
                    </h3>
                    <div class="product-rating">
                        <span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                        <span class="rating-count">3,182</span>
                    </div>
                    <div class="purchase-info">5K+ bought in past month</div>
                    <div class="limited-deal">Limited time deal</div>
                </div>

                <!-- Product 3 -->
                <div class="product-card">
                    <img src="{product3_image}" alt="Product image" class="product-image"{product3_id}>
                    <h3 class="product-title">
                        <a href="#">{product3_title}</a>
                    </h3>
                    <div class="product-rating">
                        <span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                        <span class="rating-count">4,838</span>
                    </div>
                    <div class="purchase-info">3K+ bought in past month</div>
                    <div class="product-options">Options: 2 sizes</div>
                    <div class="product-price">
                        $25<span class="price-small">19</span>
                        <span class="price-small">($4.20/count) Typical: $26.99</span>
                    </div>
                </div>

                <!-- Product 4 -->
                <div class="product-card">
                    <img src="{product4_image}" alt="Product image" class="product-image"{product4_id}>
                    <h3 class="product-title">
                        <a href="#">{product4_title}</a>
                    </h3>
                    <div class="product-rating">
                        <span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                        <span class="rating-count">1,245</span>
                    </div>
                    <div class="purchase-info">2K+ bought in past month</div>
                    <div class="product-price">$39<span class="price-small">99</span></div>
                </div>

                <!-- Product 5 -->
                <div class="product-card">
                    <img src="{product5_image}" alt="Product image" class="product-image"{product5_id}>
                    <h3 class="product-title">
                        <a href="#">{product5_title}</a>
                    </h3>
                    <div class="product-rating">
                        <span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                        <span class="rating-count">892</span>
                    </div>
                    <div class="purchase-info">1K+ bought in past month</div>
                    <div class="product-price">$89<span class="price-small">99</span></div>
                </div>

                <!-- Product 6 -->
                <div class="product-card">
                    <div class="best-seller">Best Seller</div>
                    <img src="{product6_image}" alt="Product image" class="product-image"{product6_id}>
                    <h3 class="product-title">
                        <a href="#">{product6_title}</a>
                    </h3>
                    <div class="product-rating">
                        <span class="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                        <span class="rating-count">2,156</span>
                    </div>
                    <div class="purchase-info">4K+ bought in past month</div>
                    <div class="product-price">$45<span class="price-small">99</span></div>
                </div>
            </div>
        </main>
    </div>
</body>
</html>'''

def get_available_images(images_dir: str = "images", start_index: int = 0, end_index: int = None):
    """
    Ëé∑ÂèñimagesÁõÆÂΩï‰∏≠ÊåáÂÆöËåÉÂõ¥ÁöÑÂõæÁâáÊñá‰ª∂ÂàóË°®
    
    Args:
        images_dir: ÂõæÁâáÁõÆÂΩïË∑ØÂæÑ
        start_index: ÂºÄÂßãÁ¥¢Âºï
        end_index: ÁªìÊùüÁ¥¢ÂºïÔºà‰∏çÂåÖÂê´Ôºâ
    
    Returns:
        list: ÊåâÁºñÂè∑ÊéíÂ∫èÁöÑÂõæÁâáÊñá‰ª∂ÂêçÂàóË°®
    """
    if not os.path.exists(images_dir):
        raise FileNotFoundError(f"ÂõæÁâáÁõÆÂΩï {images_dir} ‰∏çÂ≠òÂú®")
    
    # ÊîØÊåÅÁöÑÂõæÁâáÊ†ºÂºè
    supported_formats = ['.jpg', '.jpeg', '.png', '.gif', '.webp']
    
    # Ëé∑ÂèñÊâÄÊúâÂõæÁâáÊñá‰ª∂
    image_files = []
    for file in os.listdir(images_dir):
        if any(file.lower().endswith(fmt) for fmt in supported_formats):
            # Â∞ùËØïÊèêÂèñÊñá‰ª∂Âêç‰∏≠ÁöÑÊï∞Â≠ó
            try:
                # ÂÅáËÆæÊñá‰ª∂ÂêçÊ†ºÂºè‰∏∫ "Êï∞Â≠ó.Êâ©Â±ïÂêç"
                name_without_ext = os.path.splitext(file)[0]
                if name_without_ext.isdigit():
                    file_index = int(name_without_ext)
                    # Âè™ÂåÖÂê´ÊåáÂÆöËåÉÂõ¥ÂÜÖÁöÑÂõæÁâá
                    if start_index <= file_index < (end_index if end_index else float('inf')):
                        image_files.append((file_index, file))
                else:
                    print(f"‚ö†Ô∏è  Ë∑≥ËøáÈùûÊï∞Â≠óÂëΩÂêçÁöÑÂõæÁâáÊñá‰ª∂: {file}")
            except Exception as e:
                print(f"‚ö†Ô∏è  Â§ÑÁêÜÂõæÁâáÊñá‰ª∂ {file} Êó∂Âá∫Èîô: {e}")
                continue
    
    # ÊåâÊï∞Â≠óÊéíÂ∫è
    image_files.sort(key=lambda x: x[0])
    
    sorted_files = [file for _, file in image_files]
    
    return sorted_files

def generate_amazon_html(json_path: str, output_path: str, start_index: int = 0, target_index: int = None, images_dir: str = "images", image_start: int = 0, image_end: int = None):
    """
    ÁîüÊàê‰∫öÈ©¨ÈÄäÂïÜÂìÅÈ°µÈù¢HTML
    
    Args:
        json_path: amazon.jsonÁöÑË∑ØÂæÑ
        output_path: ËæìÂá∫HTMLÊñá‰ª∂Ë∑ØÂæÑ
        start_index: ÂºÄÂßãÁöÑÊï∞ÊçÆÁ¥¢Âºï
        target_index: ÁõÆÊ†áÂïÜÂìÅÁöÑÁ¥¢ÂºïÔºà0-5‰∏≠ÁöÑ‰∏Ä‰∏™‰ΩçÁΩÆÔºåÂ¶ÇÊûú‰∏∫NoneÂàôÈöèÊú∫ÈÄâÊã©Ôºâ
        images_dir: ÂõæÁâáÁõÆÂΩïË∑ØÂæÑ
        image_start: ÂõæÁâáÂºÄÂßãÁ¥¢Âºï
        image_end: ÂõæÁâáÁªìÊùüÁ¥¢Âºï
    
    Returns:
        tuple: (target_product_id, target_product_info, actual_target_index)
    """
    # ËØªÂèñÂïÜÂìÅÊï∞ÊçÆ
    with open(json_path, 'r', encoding='utf-8') as f:
        product_data = json.load(f)
    
    # Ëé∑ÂèñÊåáÂÆöËåÉÂõ¥ÁöÑÂèØÁî®ÂõæÁâáÂàóË°®
    available_images = get_available_images(images_dir, image_start, image_end)
    
    if not available_images:
        raise FileNotFoundError(f"Âú® {images_dir} ÁõÆÂΩï‰∏≠ÁöÑ {image_start}-{image_end} ËåÉÂõ¥ÂÜÖÊ≤°ÊúâÊâæÂà∞ÂèØÁî®ÁöÑÂõæÁâáÊñá‰ª∂")
    
    # ÈúÄË¶Å5‰∏™ÊôÆÈÄöÂïÜÂìÅÊï∞ÊçÆÔºàÂõ†‰∏∫Á¨¨6‰∏™‰ΩçÁΩÆÊòØtarget.jpgÔºâ
    num_regular_products = NUM_PRODUCTS - 1  # 5‰∏™
    end_idx = min(start_index + num_regular_products, len(product_data))
    selected_products = product_data[start_index:end_idx]
    
    if len(selected_products) < num_regular_products:
        print(f"‚ö†Ô∏è  Ë≠¶ÂëäÔºöÂè™Êúâ {len(selected_products)} ‰∏™ÂïÜÂìÅÊï∞ÊçÆÔºåÂ∞ë‰∫éÈ¢ÑÊúüÁöÑ {num_regular_products} ‰∏™")
    
    # Á°ÆÂÆötarget.jpgÁöÑ‰ΩçÁΩÆÔºàÈöèÊú∫ÈÄâÊã©0-5‰∏≠ÁöÑ‰∏Ä‰∏™‰ΩçÁΩÆÔºâ
    if target_index is None:
        target_index = random.randint(0, NUM_PRODUCTS - 1)
    else:
        target_index = min(target_index, NUM_PRODUCTS - 1)
    
    target_product_id = f"target-product-{target_index}"
    
    # target.jpgÁöÑÂõ∫ÂÆö‰ø°ÊÅØ
    target_product_info = {
        "title": "4-Port Charging Station for Multiple Devices, USB Charger Stations Multi-Device Organizer Charging Dock, Compatible with Cell Phones, iPads, Kindle Tablets, and Other Electronics (Gray)",
        "category": "target",
        "is_target": True
    }
    
    # Âà§Êñ≠HTMLÊñá‰ª∂ÁöÑËæìÂá∫‰ΩçÁΩÆÔºåË∞ÉÊï¥ÂõæÁâáË∑ØÂæÑ
    output_dir = Path(output_path).parent
    if output_dir.name == "html":
        # Â¶ÇÊûúËæìÂá∫Âú®htmlÁõÆÂΩï‰∏ãÔºå‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑÊåáÂêë‰∏äÁ∫ßÁõÆÂΩï
        image_path_prefix = "../../" + images_dir
        target_image_path = "../../target.jpg"
    else:
        # Â¶ÇÊûúËæìÂá∫Âú®ÂΩìÂâçÁõÆÂΩïÊàñÂÖ∂‰ªñÁõÆÂΩïÔºåÁõ¥Êé•‰ΩøÁî®images_dir
        image_path_prefix = images_dir
        target_image_path = "target.jpg"
    
    # ÂáÜÂ§á6‰∏™‰ΩçÁΩÆÁöÑÊï∞ÊçÆ
    positions = []
    regular_product_index = 0
    used_images = []
    
    for i in range(NUM_PRODUCTS):
        if i == target_index:
            # Ëøô‰∏™‰ΩçÁΩÆÊîætarget.jpg
            positions.append({
                'image': target_image_path,
                'title': target_product_info['title'],
                'id': f' id="{target_product_id}"'
            })
            used_images.append("target.jpg")
        else:
            # Ëøô‰∏™‰ΩçÁΩÆÊîæÊôÆÈÄöÂõæÁâá
            if regular_product_index < len(selected_products):
                # ÊåâÈ°∫Â∫èÈÄâÊã©ÂõæÁâáÔºå‰ªéstart_indexÂØπÂ∫îÁöÑÂõæÁâáÂºÄÂßã
                image_index = (start_index + regular_product_index) % len(available_images)
                image_filename = available_images[image_index]
                image_path = f"{image_path_prefix}/{image_filename}"
                used_images.append(image_filename)
                
                product = selected_products[regular_product_index]
                positions.append({
                    'image': image_path,
                    'title': product['title'],
                    'id': ''
                })
                regular_product_index += 1
            else:
                # Â¶ÇÊûúÊôÆÈÄöÂïÜÂìÅÊï∞ÊçÆ‰∏çÂ§üÔºåÁî®ÈªòËÆ§Êï∞ÊçÆÂ°´ÂÖÖ
                image_index = (start_index + regular_product_index) % len(available_images)
                image_filename = available_images[image_index]
                image_path = f"{image_path_prefix}/{image_filename}"
                used_images.append(image_filename)
                
                positions.append({
                    'image': image_path,
                    'title': "Default Amazon Product",
                    'id': ''
                })
                regular_product_index += 1
    
    print(f"üñºÔ∏è  ‰ΩøÁî®ÂõæÁâá: {', '.join(used_images)}")
    print(f"üéØ target‰ΩçÁΩÆ: {target_index + 1}")
    
    # ÁîüÊàêÂÆåÊï¥HTML
    full_html = HTML_TEMPLATE.format(
        product1_title=positions[0]['title'],
        product1_image=positions[0]['image'],
        product1_id=positions[0]['id'],
        product2_title=positions[1]['title'],
        product2_image=positions[1]['image'],
        product2_id=positions[1]['id'],
        product3_title=positions[2]['title'],
        product3_image=positions[2]['image'],
        product3_id=positions[2]['id'],
        product4_title=positions[3]['title'],
        product4_image=positions[3]['image'],
        product4_id=positions[3]['id'],
        product5_title=positions[4]['title'],
        product5_image=positions[4]['image'],
        product5_id=positions[4]['id'],
        product6_title=positions[5]['title'],
        product6_image=positions[5]['image'],
        product6_id=positions[5]['id']
    )
    
    # Á°Æ‰øùËæìÂá∫ÁõÆÂΩïÂ≠òÂú®
    Path(output_path).parent.mkdir(parents=True, exist_ok=True)
    
    # ÂÜôÂÖ•Êñá‰ª∂
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(full_html)
    
    return target_product_id, target_product_info, start_index + target_index

def take_screenshot(html_path: str, output_path: str):
    """
    ÂØπHTMLÈ°µÈù¢ËøõË°åÊà™Âõæ
    
    Args:
        html_path: HTMLÊñá‰ª∂Ë∑ØÂæÑ
        output_path: Êà™ÂõæËæìÂá∫Ë∑ØÂæÑ
    """
    html_uri = Path(html_path).absolute().as_uri()
    
    with sync_playwright() as p:
        browser = p.chromium.launch(args=[
            '--font-render-hinting=none',
            '--disable-font-subpixel-positioning',
            '--disable-gpu-sandbox',
            '--disable-web-security',
            '--font-render-hinting=medium',
            '--enable-font-antialiasing'
        ])
        page = browser.new_page()
        
        # ËÆæÁΩÆÊ°åÈù¢ËßÜÂè£Â§ßÂ∞èÔºàÈÄÇÂêàAmazonÈ°µÈù¢Ôºâ
        page.set_viewport_size({"width": 1280, "height": 800})
        
        page.goto(html_uri)
        
        # Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàê
        page.wait_for_load_state('networkidle')
        page.wait_for_timeout(2000)  # Á≠âÂæÖÈ°µÈù¢ÂÆåÂÖ®Ê∏≤Êüì
        
        # Êà™Âõæ
        page.screenshot(path=output_path, full_page=True)
        
        browser.close()

def get_target_image_info(html_path: str, target_product_id: str):
    """
    Ëé∑ÂèñÁõÆÊ†áÂõæÂÉèÁöÑ‰ΩçÁΩÆÂíåÂ∞∫ÂØ∏‰ø°ÊÅØ
    
    Args:
        html_path: HTMLÊñá‰ª∂Ë∑ØÂæÑ
        target_product_id: ÁõÆÊ†áÂïÜÂìÅÁöÑID
    
    Returns:
        dict: ÂåÖÂê´x, y, width, heightÁöÑÂ≠óÂÖ∏
    """
    html_uri = Path(html_path).absolute().as_uri()
    
    with sync_playwright() as p:
        browser = p.chromium.launch(args=[
            '--font-render-hinting=none',
            '--disable-font-subpixel-positioning',
            '--disable-gpu-sandbox',
            '--disable-web-security',
            '--font-render-hinting=medium',
            '--enable-font-antialiasing'
        ])
        page = browser.new_page()
        
        # ËÆæÁΩÆÊ°åÈù¢ËßÜÂè£Â§ßÂ∞èÔºåÁ°Æ‰øù‰∏éÊà™Âõæ‰∏ÄËá¥
        page.set_viewport_size({"width": 1280, "height": 800})
        
        page.goto(html_uri)
        
        # Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàê
        page.wait_for_load_state('networkidle')
        page.wait_for_timeout(2000)  # Á≠âÂæÖÈ°µÈù¢ÂÆåÂÖ®Ê∏≤Êüì
        
        # ÊâæÂà∞ÁõÆÊ†áÂïÜÂìÅÁöÑÂõæÁâáÂÖÉÁ¥†
        selector = f"#{target_product_id}"
        img_handle = page.query_selector(selector)
        
        if not img_handle:
            browser.close()
            raise RuntimeError(f"Êú™ÊâæÂà∞ÁõÆÊ†áÂõæÁâáÂÖÉÁ¥†ÔºåÈÄâÊã©Âô®: {selector}")
        
        # Ëé∑ÂèñÂõæÁâáÁöÑËæπÁïåÊ°Ü‰ø°ÊÅØ
        box = img_handle.bounding_box()
        
        browser.close()
        
        return {
            'x': int(box['x']),
            'y': int(box['y']), 
            'width': int(box['width']),
            'height': int(box['height'])
        }

def batch_generate_screenshots(json_path: str, num_batches: int = 1000, images_dir: str = "images", image_start: int = 0, image_end: int = 9000):
    """
    ÊâπÈáèÁîüÊàêËÆ≠ÁªÉÊï∞ÊçÆÊà™Âõæ
    
    Args:
        json_path: amazon.jsonÁöÑË∑ØÂæÑ
        num_batches: Ë¶ÅÁîüÊàêÁöÑÊâπÊ¨°Êï∞Èáè
        images_dir: ÂõæÁâáÁõÆÂΩïË∑ØÂæÑ
        image_start: ÂõæÁâáÂºÄÂßãÁ¥¢Âºï
        image_end: ÂõæÁâáÁªìÊùüÁ¥¢Âºï
    
    Returns:
        dict: ÂåÖÂê´ÊØè‰∏™ÊâπÊ¨°‰ø°ÊÅØÁöÑÂ≠óÂÖ∏
    """
    # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
    html_dir = "html"
    screenshots_dir = "screenshots"
    Path(html_dir).mkdir(parents=True, exist_ok=True)
    Path(screenshots_dir).mkdir(parents=True, exist_ok=True)
    
    # ËØªÂèñÂïÜÂìÅÊï∞ÊçÆÊÄªÊï∞
    with open(json_path, 'r', encoding='utf-8') as f:
        product_data = json.load(f)
    
    total_products = len(product_data)
    max_batches = total_products // (NUM_PRODUCTS - 1)  # Âõ†‰∏∫Êúâ‰∏Ä‰∏™targetÔºåÂÆûÈôÖÁî®5‰∏™ÊôÆÈÄöÂïÜÂìÅ
    
    if num_batches > max_batches:
        print(f"‚ö†Ô∏è  Ë≠¶ÂëäÔºöË¶ÅÊ±ÇÁîüÊàê {num_batches} ‰∏™ÊâπÊ¨°Ôºå‰ΩÜÊúÄÂ§öÂè™ËÉΩÁîüÊàê {max_batches} ‰∏™ÊâπÊ¨°")
        num_batches = max_batches
    
    data_dict = {}
    
    print(f"üöÄ ÂºÄÂßãÊâπÈáèÁîüÊàê {num_batches} ‰∏™ËÆ≠ÁªÉÊï∞ÊçÆÊà™Âõæ...")
    print(f"üìä ‰ΩøÁî®ÂõæÁâáËåÉÂõ¥: {image_start} - {image_end}")
    print()
    
    for batch_num in range(num_batches):
        start_index = batch_num * (NUM_PRODUCTS - 1)  # ÊØèÊâπÊ¨°Áî®5‰∏™ÂïÜÂìÅÊï∞ÊçÆ
        
        # ÁîüÊàêHTMLÊñá‰ª∂ÂêçÔºà‰ªé0ÂºÄÂßãÂëΩÂêçÔºâ
        html_filename = f"{batch_num}.html"
        html_path = os.path.join(html_dir, html_filename)
        
        # ÁîüÊàêÊà™ÂõæÊñá‰ª∂ÂêçÔºà‰ªé0ÂºÄÂßãÂëΩÂêçÔºâ
        screenshot_filename = f"{batch_num}.png"
        screenshot_path = os.path.join(screenshots_dir, screenshot_filename)
        
        # ÈöèÊú∫ÈÄâÊã©ÁõÆÊ†á‰ΩçÁΩÆ
        target_index = random.randint(0, NUM_PRODUCTS - 1)
        
        try:
            print(f"üìù Ê≠£Âú®ÁîüÊàêÁ¨¨ {batch_num} Âº†ËÆ≠ÁªÉÊà™Â±è")
            
            # ÁîüÊàêHTMLÈ°µÈù¢
            target_product_id, target_product_info, actual_target_index = generate_amazon_html(
                json_path, html_path, start_index, target_index, images_dir, image_start, image_end
            )
            
            # ËøõË°åÊà™Âõæ
            take_screenshot(html_path, screenshot_path)
            
            # Ëé∑ÂèñÁõÆÊ†áÂõæÂÉè‰ø°ÊÅØ
            target_info = get_target_image_info(html_path, target_product_id)
            
            # ÊåâÁÖßË¶ÅÊ±ÇÁöÑÊ†ºÂºè‰øùÂ≠òÊï∞ÊçÆ
            data_dict[str(batch_num)] = {
                "filename": screenshot_filename,
                "target_box": {
                    "x": target_info['x'],
                    "y": target_info['y'],
                    "w": target_info['width'],
                    "h": target_info['height']
                }
            }
            
            # ËæìÂá∫ÁõÆÊ†áÂùêÊ†á‰ø°ÊÅØ
            print(f"üéØ target.jpgÂ∑¶‰∏äËßíÂùêÊ†á: ({target_info['x']}, {target_info['y']})ÔºåÈïøÂÆΩ: {target_info['width']} x {target_info['height']}")
            print(f"‚úÖ ÂÆåÊàê")
            print()
            
        except Exception as e:
            print(f"‚ùå Â§±Ë¥•: {e}")
            continue
    
    data_file = "data.json"
    with open(data_file, 'w', encoding='utf-8') as f:
        json.dump(data_dict, f, ensure_ascii=False, indent=4)
    
    print("="*60)
    print(f"üéâ ËÆ≠ÁªÉÊï∞ÊçÆÁîüÊàêÂÆåÊàêÔºÅ")
    print(f"üìä ÊÄªÂÖ±ÁîüÊàê‰∫Ü {len(data_dict)} ‰∏™ÊúâÊïàÊà™Â±è")
    print(f"üìÅ HTMLÊñá‰ª∂ÁõÆÂΩï: {html_dir}")
    print(f"üìÅ Êà™ÂõæÁõÆÂΩï: {screenshots_dir}")
    print(f"üìÑ Êï∞ÊçÆÊñá‰ª∂: {data_file}")
    
    return data_dict

def main():
    """‰∏ªÂáΩÊï∞"""
    json_path = "amazon.json"
    images_dir = "images"
    
    # Ê£ÄÊü•ÂøÖË¶ÅÊñá‰ª∂ÂíåÁõÆÂΩï
    if not os.path.exists(json_path):
        print(f"‚ùå ÈîôËØØÔºöÊâæ‰∏çÂà∞Êñá‰ª∂ {json_path}")
        return
    
    if not os.path.exists(images_dir):
        print(f"‚ùå ÈîôËØØÔºöÊâæ‰∏çÂà∞ÂõæÁâáÁõÆÂΩï {images_dir}")
        return
    
    # ÊâπÈáèÁîüÊàêËÆ≠ÁªÉÊï∞ÊçÆÊà™Âõæ
    data_dict = batch_generate_screenshots(
        json_path=json_path,
        num_batches=500,  # ÁîüÊàê500‰∏™ËÆ≠ÁªÉÊï∞ÊçÆ
        images_dir=images_dir,
        image_start=0,    # ‰ΩøÁî®Ââç2000Âº†ÂõæÁâá
        image_end=2500
    )

if __name__ == "__main__":
    main() 